(function(t){const b=[{name:"icons/00_cherry",radius:20},{name:"icons/01_strawberry",radius:26},{name:"icons/02_grape",radius:22},{name:"icons/03_orange",radius:32},{name:"icons/04_lemon",radius:34},{name:"icons/05_pear",radius:38},{name:"icons/06_apple",radius:28},{name:"icons/07_peach",radius:40},{name:"icons/08_pineapple",radius:46},{name:"icons/09_melon",radius:50},{name:"icons/10_watermelon",radius:53}],I={0:2,2:1,1:6,6:3,3:4,4:5,5:7,7:8,8:9,9:10};(function(){const m=t.Engine.create(),w=document.getElementById("game-container"),s=window.innerWidth<=480,F=t.Render.create({element:w,engine:m,options:{wireframes:!1,background:"#f9e2bb",width:s?340:400,height:s?480:540}}),p=m.world,$=t.Bodies.rectangle(0,s?230:255,15,s?480:520,{isStatic:!0,render:{fillStyle:"#f9e2bb"}}),k=t.Bodies.rectangle(s?335:400,s?230:255,10,s?480:520,{isStatic:!0,render:{fillStyle:"#f9e2bb"}}),T=t.Bodies.rectangle(s?170:200,s?470:520,s?350:400,15,{isStatic:!0,render:{fillStyle:"#68A542"}}),_=t.Bodies.rectangle(s?170:200,0,s?350:400,10,{isStatic:!0,render:{fillStyle:"#f9e2bb"}}),O=t.Bodies.rectangle(s?170:200,s?480:530,s?350:400,20,{isStatic:!0,render:{fillStyle:"#B7BFFC"}}),G=t.Bodies.rectangle(s?170:200,80,s?360:400,10,{isStatic:!0,isSensor:!0,render:{visible:!1},label:"gameEnd"});t.World.add(p,[$,k,T,_,O,G]);const B=document.createElement("div");B.className="gameEndLine",B.style.display="none",w.appendChild(B),t.Render.run(F);const A=t.Runner.create(),L=Date.now();requestAnimationFrame(function n(){t.Runner.tick(A,m,Date.now()-L),requestAnimationFrame(n)});const e={topLineVisible:!1,topLineTriggered:!1,isGameOver:!1,score:0,currentFruit:null,disableAction:!1,currentBody:null,pairsColliding:{},bestScore:(()=>{const n=localStorage.getItem("bestScore");return n?parseInt(n):0})()},g={drop:new Audio("/sounds/drop.mp3"),collide:new Audio("/sounds/collide.mp3"),largeCandy:new Audio("/sounds/largeCandy.mp3"),burstsound:new Audio("/sounds/burst.mp3")},W=document.getElementById("scoreboard"),R=document.getElementById("bestvalue");function h(){W.textContent=`${e.score}`,R.textContent=`${e.bestScore}`}h();let f=0,x=Math.floor(5*Math.random());function v(){if(e.isGameOver)return;const n=b[f],i=n.radius,o=document.getElementById("nextCandy");o.innerHTML='<div class="next">ネクスト</div>';const r=document.createElement("img");r.src=`${b[x].name}.png`,o.appendChild(r),setTimeout(()=>{const d=t.Bodies.circle(180,50,i,{collisionFilter:{category:1,mask:1},index:f,isSleeping:!0,label:"Circle Body",render:{sprite:{texture:`${n.name}.png`}},restitution:.3,friction:.05,density:.5});let l;e.currentBody=d,e.currentFruit=n,t.World.add(p,d),h(),f=x;do l=Math.floor(6*Math.random());while(l===f);x=l},100)}let E=[];function M(n,i){for(let o=0;o<20;o++){const r=E.pop();if(!r)return;const d=10*(Math.random()-.5),l=15*(Math.random()-.5);r.style.left=`${n.x+d}px`,r.style.top=`${n.y+l}px`,r.style.setProperty("--x-translate",`${d}px`),r.style.setProperty("--y-translate",`${l}px`),r.style.animationDelay=.5*Math.random()+"s",r.style.background=`radial-gradient(circle, hsl(${360*Math.random()}, 100%, 70%), hsl(${360*Math.random()}, 100%, 50%))`,r.style.display="block",setTimeout(()=>{r.style.display="none",E.push(r)},1e3)}}function C(n){if(e.disableAction||e.isGameOver||!e.currentBody)return;const i=document.getElementById("game-container").getBoundingClientRect();let o=n.type==="mousedown"?n.clientX-i.left:n.touches[0].clientX-i.left;o=Math.max(e.currentFruit.radius,Math.min(o,i.width-e.currentFruit.radius)),e.currentBody&&(t.Body.setPosition(e.currentBody,{x:o,y:e.currentBody.position.y}),e.disableAction=!0,setTimeout(()=>{g.drop.play(),e.currentBody.isSleeping=!1,t.Body.setVelocity(e.currentBody,{x:0,y:3}),setTimeout(()=>{e.disableAction=!1,v()},1e3)},100))}(function(){for(let n=0;n<100;n++){const i=document.createElement("div");i.className="burst-animation",i.style.display="none";const o=20*Math.random()+10;i.style.width=`${o}px`,i.style.height=`${o}px`,document.getElementById("game-container").appendChild(i),E.push(i)}})(),document.getElementById("game-container").addEventListener("mousedown",C),document.getElementById("game-container").addEventListener("touchstart",C),window.onkeydown=n=>{if(!e.disableAction&&!e.isGameOver)switch(n.code){case"KeyA":e.currentBody.position.x-e.currentFruit.radius>10&&t.Body.setPosition(e.currentBody,{x:e.currentBody.position.x-10,y:e.currentBody.position.y});break;case"KeyD":const i=document.getElementById("game-container").offsetWidth;e.currentBody.position.x+e.currentFruit.radius<i-15&&t.Body.setPosition(e.currentBody,{x:e.currentBody.position.x+10,y:e.currentBody.position.y});break;case"KeyS":e.currentBody&&(e.currentBody.isSleeping=!1,g.drop.play(),e.disableAction=!0,setTimeout(()=>{v(),e.disableAction=!1},1e3))}},m.constraintIterations=10,m.positionIterations=10,t.Events.on(m,"collisionActive",n=>{n.pairs.forEach(i=>{const{bodyA:o,bodyB:r}=i;if(e.isGameOver)return;if(!e.disableAction&&(i.bodyA.label==="gameEnd"||i.bodyB.label==="gameEnd"))return B.style.display="block",void function(){e.isGameOver=!0,e.disableAction=!0;const u=p.bodies.filter(y=>y.label==="Circle Body");let a=0;e.score>e.bestScore&&(e.bestScore=e.score,localStorage.setItem("bestScore",e.bestScore));function c(){if(a>=u.length)return;const y=u[a];M(y.position),g.collide.play(),t.World.remove(p,y),a++,setTimeout(c,100)}c(),setTimeout(()=>{document.getElementById("final-score").textContent=`最終スコア: ${e.score}`;const y=new bootstrap.Modal(document.getElementById("gameOverModal"),{keyboard:!1});t.Runner.stop(A),y.show()},6e3)}();const d=o.index,l=r.index;if(t.Body.applyForce(o,o.position,{x:.005*(r.position.x-o.position.x),y:.005*(r.position.y-o.position.y)}),d!==void 0&&l!==void 0&&d===l&&!e.isGameOver&&!e.pairsColliding[d]){e.pairsColliding[d]=!0,function(a,c){if(Math.sqrt((c.position.x-a.position.x)**2+(c.position.y-a.position.y)**2)<100){const S={x:(c.position.x-a.position.x)*2e-5,y:(c.position.y-a.position.y)*2e-5};t.Body.applyForce(a,a.position,S),t.Body.applyForce(c,c.position,{x:-S.x,y:-S.y})}}(o,r),g.collide.play(),M(i.bodyA.position),g.burstsound.play(),setTimeout(()=>{t.World.remove(p,[o,r])},100),e.isGameOver||(e.score+=Math.floor(8*Math.random())+1,h());const u=I[d];if(u!==void 0&&u<b.length){const a=b[u],c=t.Bodies.circle(o.position.x,o.position.y,a.radius,{index:u,render:{sprite:{texture:`${a.name}.png`}},restitution:.3,friction:.01,density:.5});t.World.add(p,c),g.collide.play()}setTimeout(()=>{e.pairsColliding[d]=!1},100)}})}),document.getElementById("replay-button").addEventListener("click",function(){location.reload()}),v()})()})(Matter);
